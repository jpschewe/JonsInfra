<?xml version="1.0"?>
<!DOCTYPE project PUBLIC "-//ANT//DTD project//EN" "project.dtd">

<project name="infra" default="compile" basedir=".">

  <!-- properties -->
  <property name="temp.dir"  value="${basedir}/tmp" />
  
  <property name="instrument.dir"  value="instrumented" />

  <property name="build.home"    value="build"/>

  <!--
  
    These properties control option settings on the Javac compiler when it
    is invoked using the <javac> task.
  
    compile.debug        Should compilation include the debug option?
  
    compile.deprecation  Should compilation include the deprecation option?
  
    compile.optimize     Should compilation include the optimize option?
  
  -->
  
  <property name="compile.debug"       value="true"/>
  <property name="compile.deprecation" value="true"/>
  <property name="compile.optimize"    value="false"/>
  
  <property name="cvs.root" value="/net/CVS-Repository" />
  <property name="cvs.module" value="infra" />

  <!-- used for building releases -->
  <property name="app.name"   value="JonsInfra" />
  <property name="app.version" value="0.3" />
  <property name="release.cvs.tag" value="JonsInfra_0_3" />
  <property name="release.html.dir" value="/home/jpschewe/public_html/mtu.net/public_html" />
            
  <!-- used for *.javadoc -->
  <property name="local.java.packages" value="http://netserver.mn.mtu.net/package-docs/java" />
  <property name="nightly.html.dir" value="/net/package-docs/projects" />

  <path id="base.classpath">
    <pathelement location="${basedir}/src/"/>
    <pathelement location="${basedir}/lib/junit-3.8.jar"/>
    <pathelement location="${basedir}/lib/log4j-1.2.8.jar"/>
  </path>
  
  <!-- targets -->
  <target name="init">
    <tstamp />
  </target>

  
  <!--  <target name="compile" depends="init,instrument">-->
  <target name="compile" depends="init">

    <mkdir dir="${build.home}/classes"/>
    
    <!--    <javac srcdir="${instrument.dir}" destdir="${basedir}" >-->
    <javac srcdir="${basedir}/src"
           destdir="${build.home}/classes"
           debug="${compile.debug}"
           deprecation="${compile.deprecation}"
           optimize="${compile.optimize}"
           >
      <classpath>
        <path refid="base.classpath"/>
      </classpath>
      <include name="net/**/*.java"/>
    </javac>
  </target>

  <target name="runtests"
          depends="compile">
    <java fork="yes"
          classname="junit.textui.TestRunner" 
          taskname="junit" failonerror="true">
      <arg value="net.mtu.eggplant.util.test.AllTests"/>
      <classpath>
        <path refid="base.classpath"/>
        <pathelement location="${build.home}/classes" />
      </classpath>
    </java>
  </target>

<!--  <target name="instrument" depends="init">
    <java fork="no" classname="net.mtu.eggplant.assert.JonsAssert"
          taskname="assert" failonerror="true">
      <arg value="${basedir}/src/net/" />
      <arg value="-d ${basedir}/${instrument.dir}" />
    </java>
  </target>-->

  <target name="clean"
         description="Delete old build and dist directories">
    <delete dir="${build.home}"/>
  </target>


  <!-- Javadoc targets below here -->
  
  <!-- do a local build without external links -->
  <target name="local.javadoc">
    <mkdir dir="${basedir}/api" />
    <javadoc packagenames="net.mtu.eggplant.*"
             sourcepath="{$basedir}/src"
             use="true"
             splitindex="true"
             version="true"
             windowtitle="${app.name}"
             destdir="${basedir}/api"
             additionalparam="-tag beaninfo:a:BeanInfo -tag test:a:Tests -tag pre:cm:PreConditions -tag post:cm:PostConditions -tag invariant:tc:Invariants -breakiterator"
             >
        <classpath>
          <path refid="base.classpath"/>
        </classpath>
      </javadoc>
  </target>

  <!-- do a nightly build to my fileserver -->
  <target name="nightly.javadoc">
    <mkdir dir="${temp.dir}" />    
    <!-- get the source out of cvs -->
    <cvs cvsRoot="${cvs.root}"
         package="${cvs.module}"
         dest="${temp.dir}"
         quiet="true" />
    
    <!-- run javadoc on the source -->
    <mkdir dir="${nightly.html.dir}/${app.name}" />
    <javadoc packagenames="net.mtu.eggplant.*"
             sourcepath="${basedir}/src"
             use="true"
             splitindex="true"
             version="true"
             windowtitle="${app.name}"
             destdir="${nightly.html.dir}/${app.name}"
             additionalparam="-tag beaninfo:a:BeanInfo -tag test:a:Tests -tag pre:cm:PreConditions -tag post:cm:PostConditions -tag invariant:tc:Invariants -breakiterator"
             >
      <classpath>
        <path refid="base.classpath"/>
      </classpath>
      <!-- core java -->
      <link href="${local.java.packages}/jdk-1.4.0/api/"/>
      <!-- junit -->
      <link href="${local.java.packages}/junit-3.8/" />
    </javadoc>
    
    <!-- delete the temp files -->
    <delete dir="${temp.dir}" />
  </target>

  <!-- do a release, the tag is created manually -->
  <target name="release">
    <mkdir dir="${release.html.dir}/${app.name}/${app.version}" />
           
    <!-- checkout to a temp directory -->
    <cvs cvsRoot="${cvs.root}"
         package="${cvs.module}"
         dest="${temp.dir}"
         tag="${release.cvs.tag}" />

    <!-- copy index.html, ChangeLog to web directory -->
    <copy todir="${release.html.dir}/${app.name}/${app.version}"
          flatten="true">
      <fileset dir="${temp.dir}/infra">
        <include name="ChangeLog" />
        <include name="doc/index.html" />
      </fileset>
    </copy>

    <!-- zip source to web directory -->
    <zip basedir="${temp.dir}"
         destfile="${release.html.dir}/${app.name}/${app.version}/${app.name}-${app.version}-src.zip"
         />

    <!-- compile -->
    <javac srcdir="${temp.dir}/infra/src" destdir="${temp.dir}/infra/src">
      <classpath>
        <pathelement location="${temp.dir}/infra/src/" />
        <pathelement location="${temp.dir}/infra/lib/junit-3.8.jar" />
      </classpath>
      <include name="net/**/*.java"/>
    </javac>
    
    <!-- build the jar -->
    <jar jarfile="${release.html.dir}/${app.name}/${app.version}/${app.name}-${app.version}.jar"
         basedir="${temp.dir}/infra/src"
         excludes="**/*.java"
          />

    
    <!-- generate javadoc -->
    <antcall target="release.javadoc" />

    <!-- delete the temp files -->
    <delete dir="${temp.dir}" />
    
    <echo message="Remember to sync out to mtu.net" />
  </target>
  
  <target name="release.javadoc">
    <mkdir dir="${temp.dir}" />
    <!-- get the source out of cvs -->
    <cvs cvsRoot="${cvs.root}"
         package="${cvs.module}"
         dest="${temp.dir}"
         tag="${release.cvs.tag}" />
    <!-- run javadoc on the source -->
    <mkdir dir="${release.html.dir}/${app.name}/${app.version}/api" />
    <javadoc packagenames="net.mtu.eggplant.*"
             sourcepath="${temp.dir}/infra/src"
             use="true"
             splitindex="true"
             version="true"
             windowtitle="${app.name}-${app.version}"
             destdir="${release.html.dir}/${app.name}/${app.version}/api"
             additionalparam="-tag beaninfo:a:BeanInfo -tag test:a:Tests -tag pre:cm:PreConditions -tag post:cm:PostConditions -tag invariant:tc:Invariants -breakiterator"
             >
        <classpath>
          <pathelement location="${temp.dir}/infra/src/" />
          <pathelement location="${temp.dir}/infra/lib/junit-3.8.jar" />
        </classpath>
        <!-- core java -->
        <link href="http://java.sun.com/j2se/1.4/docs/api/" />
        <!-- junit -->
        <link href="http://www.junit.org/junit/javadoc/3.8/" />
      </javadoc>
    
    <!-- delete the temp files -->
    <delete dir="${temp.dir}" />
  </target>
  
</project>